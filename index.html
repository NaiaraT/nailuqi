<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QI Master - Jogo de Perguntas e Respostas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #1e293b; /* Dark slate text */
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 24px;
            margin-bottom: 20px;
        }
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
        }
        .btn-primary {
            background-color: #3b82f6; /* Blue-500 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Blue-600 */
        }
        .btn-secondary {
            background-color: #e5e7eb; /* Gray-200 */
            color: #374151; /* Gray-700 */
        }
        .btn-secondary:hover {
            background-color: #d1d5db; /* Gray-300 */
        }
        .option-btn {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            border: 1px solid #d1d5db; /* Gray-300 */
        }
        .option-btn.correct {
            background-color: #10b981; /* Emerald-500 */
            color: white;
            border-color: #059669; /* Emerald-600 */
        }
        .option-btn.incorrect {
            background-color: #ef4444; /* Red-500 */
            color: white;
            border-color: #dc2626; /* Red-600 */
        }
        .disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        #loading-spinner, #error-message, #high-score-form, #high-scores-list {
            display: none; /* Hidden by default */
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s ease infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .btn-difficulty.selected-difficulty {
            outline: 3px solid #facc15; /* Yellow-400 for selection */
            box-shadow: 0 0 0 4px rgba(250, 204, 21, 0.5); /* Yellow-400 with opacity */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-gradient-to-br from-slate-900 to-slate-700 text-slate-100">
    <div class="container">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-sky-400">QI Master</h1>
            <p class="text-slate-300">Teste os seus conhecimentos!</p>
            <p class="text-xs text-slate-400 mt-2">User ID: <span id="user-id-display">A autenticar...</span></p>
        </header>

        <div id="start-screen" class="card bg-slate-800">
            <h2 class="text-2xl font-semibold mb-4 text-sky-300">Bem-vindo!</h2>
            
            <div class="mb-6">
                <p class="text-slate-300 mb-3 text-center font-semibold">Escolha o n√≠vel de dificuldade:</p>
                <div class="flex justify-center space-x-2 sm:space-x-3">
                    <button data-difficulty="F√°cil" class="btn btn-difficulty bg-green-500 hover:bg-green-600 text-white px-3 py-2 sm:px-4 text-sm sm:text-base">F√°cil</button>
                    <button data-difficulty="Dif√≠cil" class="btn btn-difficulty bg-sky-500 hover:bg-sky-600 text-white px-3 py-2 sm:px-4 text-sm sm:text-base selected-difficulty">Dif√≠cil</button>
                    <button data-difficulty="Fod√£o" class="btn btn-difficulty bg-red-500 hover:bg-red-600 text-white px-3 py-2 sm:px-4 text-sm sm:text-base">Fod√£o</button>
                </div>
            </div>
            
            <p class="mb-6 text-slate-300 text-center">Pronto para o desafio? Clique abaixo para come√ßar.</p>
            <button id="start-game-btn" class="btn btn-primary w-full">Come√ßar Jogo</button>
            <div id="initial-loading-spinner" class="spinner my-4" style="display: none;"></div>
            <div id="initial-error-message" class="text-red-400 my-4" style="display: none;"></div>
        </div>

        <div id="game-screen" class="card bg-slate-800" style="display: none;">
            <div class="flex justify-between items-center mb-4">
                <span id="question-category" class="text-sm font-semibold bg-sky-500 text-white px-3 py-1 rounded-full">Categoria</span>
                <span id="score" class="text-lg font-bold text-amber-400">Pontua√ß√£o: 0</span>
            </div>
            <div id="question-container" class="mb-6">
                <p id="question-text" class="text-xl mb-4 text-slate-200">A carregar pergunta...</p>
                <div id="options-container">
                    <!-- As op√ß√µes ser√£o inseridas dinamicamente aqui -->
                </div>
            </div>
            <div class="flex justify-between items-center">
                <span id="question-counter" class="text-sm text-slate-400">Pergunta 1 / 10</span>
                <button id="next-question-btn" class="btn btn-secondary" style="display: none;">Pr√≥xima Pergunta</button>
            </div>
            <div id="feedback-message" class="mt-4 text-center font-semibold"></div>
        </div>

        <div id="end-screen" class="card bg-slate-800" style="display: none;">
            <h2 class="text-2xl font-semibold mb-4 text-sky-300">Fim de Jogo!</h2>
            <p id="final-score" class="text-xl mb-6 text-amber-400">A sua pontua√ß√£o final √©: 0</p>
            
            <div id="high-score-form" class="mb-6">
                <label for="player-name" class="block mb-2 text-sm font-medium text-slate-300">Digite o seu nome para guardar a pontua√ß√£o:</label>
                <input type="text" id="player-name" class="w-full p-2 border border-slate-600 rounded-md bg-slate-700 text-slate-200 focus:ring-sky-500 focus:border-sky-500" placeholder="O seu Nome">
                <button id="save-score-btn" class="btn btn-primary w-full mt-3">Guardar Pontua√ß√£o</button>
                <p id="save-status" class="text-sm mt-2 text-center"></p>
            </div>
            
            <button id="play-again-btn" class="btn btn-primary w-full mb-4">Jogar Novamente</button>
        </div>

        <div id="high-scores-section" class="card bg-slate-800 mt-8">
            <h3 class="text-xl font-semibold mb-4 text-sky-300">üèÜ Melhores Pontua√ß√µes üèÜ</h3>
            <div id="high-scores-loading-spinner" class="spinner" style="display: none;"></div>
            <ul id="high-scores-list" class="space-y-2 text-slate-300">
                <!-- As melhores pontua√ß√µes ser√£o listadas aqui -->
            </ul>
             <p id="no-high-scores" class="text-slate-400" style="display:none;">Ainda n√£o h√° pontua√ß√µes registadas.</p>
        </div>

        <!-- Modal de Mensagem -->
        <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" style="display: none;">
            <div class="bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm w-full">
                <h4 id="modal-title" class="text-lg font-semibold mb-3 text-sky-400">Mensagem</h4>
                <p id="modal-message" class="text-slate-300 mb-4"></p>
                <button id="modal-close-btn" class="btn btn-primary w-full">OK</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, getDocs, limit, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'qi-master-default-app-id';

        let app;
        let auth;
        let db;
        let userId;
        let isAuthReady = false;

        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const startGameBtn = document.getElementById('start-game-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const playAgainBtn = document.getElementById('play-again-btn');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const scoreEl = document.getElementById('score');
        const finalScoreEl = document.getElementById('final-score');
        const questionCounterEl = document.getElementById('question-counter');
        const questionCategoryEl = document.getElementById('question-category');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const highScoreForm = document.getElementById('high-score-form');
        const playerNameInput = document.getElementById('player-name');
        const saveScoreBtn = document.getElementById('save-score-btn');
        const saveStatusEl = document.getElementById('save-status');
        const highScoresListEl = document.getElementById('high-scores-list');
        const highScoresLoadingSpinner = document.getElementById('high-scores-loading-spinner');
        const noHighScoresMsg = document.getElementById('no-high-scores');
        const initialLoadingSpinner = document.getElementById('initial-loading-spinner');
        const initialErrorMessage = document.getElementById('initial-error-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const difficultyButtons = document.querySelectorAll('.btn-difficulty');
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        const TOTAL_QUESTIONS = 10;
        let selectedDifficulty = 'Dif√≠cil'; 

        // --- BANCO DE PERGUNTAS INTERNO EXPANDIDO ---
        const questionBank = {
            'F√°cil': [
                { question: "Qual √© a capital de Portugal?", options: ["Porto", "Lisboa", "Faro", "Coimbra"], correctAnswer: 1, category: "Geografia" },
                { question: "Quantos planetas existem no nosso Sistema Solar?", options: ["7", "8", "9", "10"], correctAnswer: 1, category: "Ci√™ncia" },
                { question: "Quem pintou a Mona Lisa?", options: ["Vincent van Gogh", "Pablo Picasso", "Leonardo da Vinci", "Michelangelo"], correctAnswer: 2, category: "Artes" },
                { question: "Qual √© o maior oceano da Terra?", options: ["Atl√¢ntico", "√çndico", "√Årtico", "Pac√≠fico"], correctAnswer: 3, category: "Geografia" },
                { question: "Qual animal √© conhecido como o 'Rei da Selva'?", options: ["Tigre", "Le√£o", "Elefante", "Urso"], correctAnswer: 1, category: "Natureza" },
                { question: "Em que ano o homem pisou na Lua pela primeira vez?", options: ["1969", "1972", "1965", "1980"], correctAnswer: 0, category: "Hist√≥ria" },
                { question: "Qual √© a cor do c√©u num dia limpo?", options: ["Verde", "Amarelo", "Azul", "Laranja"], correctAnswer: 2, category: "Conhecimentos Gerais" },
                { question: "Quantos lados tem um tri√¢ngulo?", options: ["2", "3", "4", "5"], correctAnswer: 1, category: "Matem√°tica" },
                { question: "Qual √© o principal ingrediente do p√£o?", options: ["A√ß√∫car", "Sal", "Farinha", "Ovos"], correctAnswer: 2, category: "Culin√°ria" },
                { question: "Quem escreveu 'Dom Quixote'?", options: ["William Shakespeare", "Miguel de Cervantes", "Machado de Assis", "Homero"], correctAnswer: 1, category: "Literatura" },
                { question: "Que pa√≠s tem o formato de uma bota?", options: ["Espanha", "Gr√©cia", "It√°lia", "Portugal"], correctAnswer: 2, category: "Geografia" },
                { question: "Qual √© a moeda oficial do Jap√£o?", options: ["Yuan", "Won", "Yen", "D√≥lar"], correctAnswer: 2, category: "Conhecimentos Gerais" },
                { question: "Qual processo transforma a √°gua em gelo?", options: ["Evapora√ß√£o", "Condensa√ß√£o", "Solidifica√ß√£o", "Fervura"], correctAnswer: 2, category: "Ci√™ncia" },
                { question: "Quem √© o super-her√≥i conhecido como o 'Homem de A√ßo'?", options: ["Batman", "Super-Homem", "Hulk", "Homem-Aranha"], correctAnswer: 1, category: "Cultura Pop" },
                { question: "Qual √© o rio mais longo do mundo?", options: ["Rio Nilo", "Rio Amazonas", "Rio Mississipi", "Rio Yangtz√©"], correctAnswer: 1, category: "Geografia" },
                { question: "Quantos dias tem um ano bissexto?", options: ["364", "365", "366", "367"], correctAnswer: 2, category: "Conhecimentos Gerais" },
                { question: "Em que continente fica o Egito?", options: ["√Åsia", "Europa", "√Åfrica", "Oceania"], correctAnswer: 2, category: "Geografia" },
                { question: "Qual √© o metal mais abundante na crosta terrestre?", options: ["Ferro", "Cobre", "Ouro", "Alum√≠nio"], correctAnswer: 3, category: "Ci√™ncia" },
                { question: "Qual instrumento musical tem 88 teclas?", options: ["Viol√£o", "Violino", "Piano", "Flauta"], correctAnswer: 2, category: "M√∫sica" },
                { question: "Quem foi a primeira mulher a voar sozinha sobre o Atl√¢ntico?", options: ["Marie Curie", "Amelia Earhart", "Valentina Tereshkova", "Rosa Parks"], correctAnswer: 1, category: "Hist√≥ria" },
            ],
            'Dif√≠cil': [
                { question: "Qual √© o elemento qu√≠mico cujo s√≠mbolo √© 'W'?", options: ["Tungst√©nio", "Prata", "Ouro", "Ferro"], correctAnswer: 0, category: "Ci√™ncia" },
                { question: "Em que ano caiu o Muro de Berlim?", options: ["1987", "1989", "1991", "1993"], correctAnswer: 1, category: "Hist√≥ria" },
                { question: "Quem foi o primeiro Imperador de Roma?", options: ["J√∫lio C√©sar", "Nero", "Augusto", "Cal√≠gula"], correctAnswer: 2, category: "Hist√≥ria" },
                { question: "Qual √© a montanha mais alta do Jap√£o?", options: ["Monte Everest", "Monte Kilimanjaro", "Monte Fuji", "Monte K2"], correctAnswer: 2, category: "Geografia" },
                { question: "Qual destes fil√≥sofos foi o mentor de Alexandre, o Grande?", options: ["Plat√£o", "S√≥crates", "Arist√≥teles", "Di√≥genes"], correctAnswer: 2, category: "Hist√≥ria" },
                { question: "Qual √© a velocidade da luz no v√°cuo (aproximadamente)?", options: ["300.000 km/h", "300.000 km/s", "150.000 km/s", "500.000 km/s"], correctAnswer: 1, category: "F√≠sica" },
                { question: "Quem escreveu a obra 'Cem Anos de Solid√£o'?", options: ["Jorge Luis Borges", "Julio Cort√°zar", "Mario Vargas Llosa", "Gabriel Garc√≠a M√°rquez"], correctAnswer: 3, category: "Literatura" },
                { question: "Qual pa√≠s √© o maior produtor de caf√© do mundo?", options: ["Col√¥mbia", "Vietname", "Brasil", "Eti√≥pia"], correctAnswer: 2, category: "Geografia" },
                { question: "O que mede a Escala Richter?", options: ["Velocidade do vento", "Intensidade de terramotos", "N√≠vel de pH", "Press√£o atmosf√©rica"], correctAnswer: 1, category: "Ci√™ncia" },
                { question: "Qual o nome do processo pelo qual as plantas produzem o seu pr√≥prio alimento?", options: ["Respira√ß√£o", "Transpira√ß√£o", "Fotoss√≠ntese", "Germina√ß√£o"], correctAnswer: 2, category: "Biologia" },
                { question: "Qual cidade era a capital do Imp√©rio Bizantino?", options: ["Roma", "Atenas", "Constantinopla", "Alexandria"], correctAnswer: 2, category: "Hist√≥ria" },
                { question: "O que √© a 'mat√©ria escura' no contexto do universo?", options: ["Poeira c√≥smica", "Uma forma de mat√©ria que n√£o emite luz", "O centro de um buraco negro", "Antimat√©ria"], correctAnswer: 1, category: "Astrof√≠sica" },
                { question: "Qual compositor cl√°ssico ficou surdo no final da sua vida?", options: ["Mozart", "Bach", "Beethoven", "Chopin"], correctAnswer: 2, category: "M√∫sica" },
                { question: "Na mitologia grega, quem matou a Medusa?", options: ["H√©rcules", "Teseu", "Perseu", "Aquiles"], correctAnswer: 2, category: "Mitologia" },
                { question: "A Guerra dos Cem Anos foi travada entre quais reinos?", options: ["Espanha e Portugal", "Inglaterra e Fran√ßa", "Roma e Cartago", "Pr√∫ssia e √Åustria"], correctAnswer: 1, category: "Hist√≥ria" },
                { question: "Qual √© o osso mais longo do corpo humano?", options: ["T√≠bia", "√ömero", "F√™mur", "F√≠bula"], correctAnswer: 2, category: "Biologia" },
                { question: "Quem √© o autor da famosa pe√ßa 'Hamlet'?", options: ["S√≥focles", "Christopher Marlowe", "William Shakespeare", "Moli√®re"], correctAnswer: 2, category: "Literatura" },
                { question: "Qual o nome do primeiro sat√©lite artificial lan√ßado pela Uni√£o Sovi√©tica?", options: ["Vostok 1", "Sputnik 1", "Explorer 1", "Luna 1"], correctAnswer: 1, category: "Tecnologia" },
                { question: "Qual destes artistas √© um famoso expoente do Surrealismo?", options: ["Claude Monet", "Salvador Dal√≠", "Caravaggio", "Rembrandt"], correctAnswer: 1, category: "Artes" },
                { question: "O que estuda a micologia?", options: ["Micr√≥bios", "Insetos", "Fungos", "Minerais"], correctAnswer: 2, category: "Biologia" },
            ],
            'Fod√£o': [
                { question: "O que √© o 'Paradoxo de Fermi'?", options: ["Um paradoxo sobre a viagem no tempo", "A contradi√ß√£o entre a alta probabilidade de vida extraterrestre e a falta de evid√™ncias", "Um problema de l√≥gica sobre conjuntos que se cont√™m a si mesmos", "Um paradoxo sobre a natureza da consci√™ncia"], correctAnswer: 1, category: "Astrof√≠sica" },
                { question: "Qual foi o supercontinente que existiu antes de Pangeia?", options: ["Gondwana", "Laur√°sia", "Rod√≠nia", "Col√∫mbia"], correctAnswer: 2, category: "Geologia" },
                { question: "No contexto da criptografia, o que √© um 'ataque de canal lateral' (side-channel attack)?", options: ["Um ataque que explora falhas no algoritmo matem√°tico", "Um ataque que visa roubar as chaves f√≠sicas", "Um ataque baseado em informa√ß√µes obtidas da implementa√ß√£o f√≠sica do sistema", "Um ataque de nega√ß√£o de servi√ßo"], correctAnswer: 2, category: "Tecnologia" },
                { question: "A 'Equa√ß√£o do Foguete de Tsiolkovsky' descreve o movimento de ve√≠culos que seguem qual princ√≠pio b√°sico?", options: ["A lei da gravita√ß√£o universal", "As leis de Kepler", "O princ√≠pio de Bernoulli", "A conserva√ß√£o do momento linear"], correctAnswer: 3, category: "F√≠sica" },
                { question: "Qual destes n√£o √© um dos 'Problemas do Pr√©mio Millennium' em matem√°tica?", options: ["A Hip√≥tese de Riemann", "O Problema P versus NP", "A Conjectura de Goldbach", "A Conjectura de Poincar√©"], correctAnswer: 2, category: "Matem√°tica" },
                { question: "Qual √© o nome do efeito qu√¢ntico que permite que uma part√≠cula atravesse uma barreira de potencial, mesmo sem ter energia suficiente?", options: ["Efeito Fotoel√©trico", "Efeito Compton", "Emaranhamento Qu√¢ntico", "Tunelamento Qu√¢ntico"], correctAnswer: 3, category: "F√≠sica Qu√¢ntica" },
                { question: "Quem √© considerado o 'pai da teoria dos jogos', autor do artigo que a fundou em 1928?", options: ["John Nash", "Alan Turing", "John von Neumann", "Kurt G√∂del"], correctAnswer: 2, category: "Ci√™ncia/Hist√≥ria" },
                { question: "Na lingu√≠stica, o que √© a 'Hip√≥tese de Sapir-Whorf'?", options: ["Uma teoria sobre a origem da linguagem", "A ideia de que a estrutura de uma l√≠ngua afeta a cogni√ß√£o dos seus falantes", "Um modelo para a tradu√ß√£o autom√°tica", "Uma teoria sobre a aquisi√ß√£o da segunda l√≠ngua"], correctAnswer: 1, category: "Lingu√≠stica" },
                { question: "Qual o nome da primeira sonda espacial a chegar ao espa√ßo interestelar?", options: ["Pioneer 10", "Voyager 2", "Voyager 1", "New Horizons"], correctAnswer: 2, category: "Astronomia" },
                { question: "Qual obra de Fi√≥dor Dostoi√©vski explora o tema do niilismo atrav√©s do personagem Rask√≥lnikov?", options: ["Os Irm√£os Karamazov", "O Idiota", "Crime e Castigo", "Dem√¥nios"], correctAnswer: 2, category: "Literatura" },
                { question: "Qual √© o √∫nico pa√≠s do mundo cujo nome em ingl√™s come√ßa com a letra 'Q'?", options: ["Qu√©nia", "Qatar", "Quirguist√£o", "Nenhum"], correctAnswer: 1, category: "Curiosidades" },
                { question: "O '√öltimo Teorema de Fermat' foi finalmente provado por qual matem√°tico em 1994?", options: ["Carl Friedrich Gauss", "Leonhard Euler", "Andrew Wiles", "David Hilbert"], correctAnswer: 2, category: "Matem√°tica" },
                { question: "Qual evento hist√≥rico √© conhecido como a 'Crise dos M√≠sseis de Outubro' em Cuba, mas como a 'Crise do Caribe' na R√∫ssia?", options: ["A Invas√£o da Ba√≠a dos Porcos", "A Crise de Suez", "O impasse nuclear de 1962", "A Revolu√ß√£o Cubana"], correctAnswer: 2, category: "Hist√≥ria" },
                { question: "Em termos de computa√ß√£o, qual arquitetura de processador domina o mercado de smartphones?", options: ["x86", "ARM", "MIPS", "PowerPC"], correctAnswer: 1, category: "Tecnologia" },
                { question: "O 'Gato de Schr√∂dinger' √© um experimento mental que ilustra qual princ√≠pio da mec√¢nica qu√¢ntica?", options: ["Princ√≠pio da Incerteza", "Superposi√ß√£o", "Emaranhamento", "Dualidade onda-part√≠cula"], correctAnswer: 1, category: "F√≠sica Qu√¢ntica" },
                { question: "Qual √© o animal terrestre mais venenoso do mundo?", options: ["Cobra-real", "Aranha-armadeira", "Escorpi√£o-amarelo", "Sapo-flecha-dourado"], correctAnswer: 3, category: "Biologia" },
                { question: "A 'Sequ√™ncia de Fibonacci' aparece frequentemente na natureza. Qual √© o pr√≥ximo n√∫mero na sequ√™ncia: 0, 1, 1, 2, 3, 5, 8, ...?", options: ["11", "12", "13", "14"], correctAnswer: 2, category: "Matem√°tica" },
                { question: "Que pintor holand√™s √© famoso por cortar parte da sua pr√≥pria orelha?", options: ["Rembrandt", "Vermeer", "Van Gogh", "Bosch"], correctAnswer: 2, category: "Artes" },
                { question: "O que o acr√≥nimo 'LASER' significa?", options: ["Light Amplification by Stimulated Emission of Radiation", "Light Absorption by Spontaneous Emission of Radiation", "Luminous Activity Stimulated by External Radiation", "Light Amplification by Saturated Energy Reaction"], correctAnswer: 0, category: "Tecnologia" },
                { question: "Qual o nome do mar que separa a Europa da √Åfrica?", options: ["Mar Negro", "Mar Vermelho", "Mar Mediterr√¢neo", "Mar C√°spio"], correctAnswer: 2, category: "Geografia" },
            ]
        };

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug');

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Utilizador autenticado com UID:", userId);
                        isAuthReady = true;
                        userIdDisplay.textContent = userId;
                        fetchHighScores();
                    } else {
                        userId = null;
                        isAuthReady = false; 
                        console.log("Utilizador n√£o autenticado.");
                        userIdDisplay.textContent = "Offline";
                    }
                });

                await authenticateUser();

            } catch (error) {
                console.error("Erro na inicializa√ß√£o do Firebase:", error);
                showModal("Erro de Inicializa√ß√£o", "N√£o foi poss√≠vel conectar aos servi√ßos de pontua√ß√£o. O jogo funcionar√°, mas sem ranking online.");
                userIdDisplay.textContent = "Offline";
                isAuthReady = true;
            }
        }
        
        async function authenticateUser() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Erro durante o processo de autentica√ß√£o:", error);
                isAuthReady = true;
                userIdDisplay.textContent = "Offline";
                showModal("Modo Offline", "N√£o foi poss√≠vel autenticar com o servidor. As pontua√ß√µes n√£o ser√£o guardadas online.");
            }
        }
        
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.style.display = 'flex';
        }

        modalCloseBtn.addEventListener('click', () => {
            messageModal.style.display = 'none';
        });

        difficultyButtons.forEach(button => {
            button.addEventListener('click', () => {
                selectedDifficulty = button.dataset.difficulty;
                difficultyButtons.forEach(btn => btn.classList.remove('selected-difficulty'));
                button.classList.add('selected-difficulty');
            });
        });

        function fetchQuestions(difficulty) {
            return new Promise((resolve, reject) => {
                initialLoadingSpinner.style.display = 'block';
                startGameBtn.classList.add('disabled');

                setTimeout(() => {
                    try {
                        const questionPool = questionBank[difficulty];
                        if (!questionPool) {
                            throw new Error(`Dificuldade "${difficulty}" n√£o encontrada.`);
                        }

                        const shuffled = [...questionPool].sort(() => 0.5 - Math.random());
                        const selectedQuestions = shuffled.slice(0, TOTAL_QUESTIONS);
                        
                        initialLoadingSpinner.style.display = 'none';
                        startGameBtn.classList.remove('disabled');
                        resolve(selectedQuestions);

                    } catch (error) {
                        console.error("Erro ao buscar perguntas locais:", error);
                        initialErrorMessage.textContent = `Erro ao carregar perguntas: ${error.message}.`;
                        initialErrorMessage.style.display = 'block';
                        initialLoadingSpinner.style.display = 'none';
                        startGameBtn.classList.remove('disabled');
                        reject(error);
                    }
                }, 300);
            });
        }

        async function startGame() {
            try {
                const fetchedQuestions = await fetchQuestions(selectedDifficulty);
                if (!fetchedQuestions || fetchedQuestions.length === 0) return;
                
                questions = fetchedQuestions;
                currentQuestionIndex = 0;
                score = 0;
                scoreEl.textContent = `Pontua√ß√£o: ${score}`;
                feedbackMessageEl.textContent = '';
                startScreen.style.display = 'none';
                endScreen.style.display = 'none';
                gameScreen.style.display = 'block';
                highScoreForm.style.display = 'none'; 
                saveStatusEl.textContent = '';
                playerNameInput.value = '';
                displayQuestion();
            } catch (error) {
                showModal("Erro", "N√£o foi poss√≠vel iniciar o jogo. " + error.message);
            }
        }

        function displayQuestion() {
            if (currentQuestionIndex >= questions.length) {
                endGame();
                return;
            }

            const currentQuestion = questions[currentQuestionIndex];
            questionTextEl.textContent = currentQuestion.question;
            questionCategoryEl.textContent = currentQuestion.category || 'Geral';
            questionCounterEl.textContent = `Pergunta ${currentQuestionIndex + 1} / ${questions.length}`;
            optionsContainer.innerHTML = '';
            feedbackMessageEl.textContent = '';
            nextQuestionBtn.style.display = 'none';

            currentQuestion.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('btn', 'option-btn', 'text-left', 'bg-slate-700', 'hover:bg-slate-600', 'text-slate-200');
                button.addEventListener('click', () => selectAnswer(index));
                optionsContainer.appendChild(button);
            });
        }

        function selectAnswer(selectedIndex) {
            const currentQuestion = questions[currentQuestionIndex];
            const correct = selectedIndex === currentQuestion.correctAnswer;

            Array.from(optionsContainer.children).forEach((btn, index) => {
                btn.classList.add('disabled'); 
                if (index === currentQuestion.correctAnswer) {
                    btn.classList.add('correct');
                } else if (index === selectedIndex && !correct) {
                    btn.classList.add('incorrect');
                }
            });

            if (correct) {
                score += 10;
                scoreEl.textContent = `Pontua√ß√£o: ${score}`;
                feedbackMessageEl.textContent = 'Correto! ÔøΩ';
                feedbackMessageEl.className = 'mt-4 text-center font-semibold text-green-400';
            } else {
                feedbackMessageEl.textContent = 'Incorreto. üôÅ';
                feedbackMessageEl.className = 'mt-4 text-center font-semibold text-red-400';
            }
            nextQuestionBtn.style.display = 'block';
        }

        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        function endGame() {
            gameScreen.style.display = 'none';
            endScreen.style.display = 'block';
            finalScoreEl.textContent = `A sua pontua√ß√£o final √©: ${score}`;
            highScoreForm.style.display = 'block'; 
            fetchHighScores(); 
        }

        async function saveHighScore() {
            if (!userId) {
                showModal("Fun√ß√£o Indispon√≠vel", "N√£o foi poss√≠vel guardar a sua pontua√ß√£o porque n√£o est√° autenticado. Verifique a sua conex√£o e tente novamente.");
                return;
            }
            const playerName = playerNameInput.value.trim();
            if (!playerName) {
                saveStatusEl.textContent = "Por favor, insira o seu nome.";
                saveStatusEl.className = 'text-sm mt-2 text-center text-yellow-400';
                return;
            }

            saveScoreBtn.classList.add('disabled');
            saveScoreBtn.textContent = 'A guardar...';

            try {
                const highScoresColPath = `artifacts/${appId}/public/data/quizHighscores`;
                const highScoresCol = collection(db, highScoresColPath);
                
                await addDoc(highScoresCol, {
                    name: playerName,
                    score: score,
                    timestamp: serverTimestamp(), 
                    userId: userId,
                    difficulty: selectedDifficulty
                });
                saveStatusEl.textContent = "Pontua√ß√£o guardada com sucesso!";
                saveStatusEl.className = 'text-sm mt-2 text-center text-green-400';
                playerNameInput.value = '';
                highScoreForm.style.display = 'none'; 
                fetchHighScores(); 
            } catch (error) {
                console.error("Erro ao guardar pontua√ß√£o:", error);
                saveStatusEl.textContent = "Erro ao guardar. Tente novamente.";
                saveStatusEl.className = 'text-sm mt-2 text-center text-red-400';
                showModal("Erro ao Guardar", `N√£o foi poss√≠vel guardar a sua pontua√ß√£o: ${error.message}`);
            } finally {
                saveScoreBtn.classList.remove('disabled');
                saveScoreBtn.textContent = 'Guardar Pontua√ß√£o';
            }
        }

        async function fetchHighScores() {
            if (!isAuthReady || !db || !userId) {
                 console.log("FetchHighScores: Auth n√£o pronta, DB n√£o inicializado, ou utilizador offline.");
                 noHighScoresMsg.textContent = "Ranking online indispon√≠vel.";
                 noHighScoresMsg.style.display = 'block';
                 highScoresListEl.innerHTML = '';
                 return;
            }
            highScoresLoadingSpinner.style.display = 'block';
            highScoresListEl.innerHTML = '';
            noHighScoresMsg.style.display = 'none';

            try {
                const highScoresColPath = `artifacts/${appId}/public/data/quizHighscores`;
                const q = query(collection(db, highScoresColPath), limit(50)); 
                const querySnapshot = await getDocs(q);
                
                let scoresData = [];
                querySnapshot.forEach((doc) => {
                    scoresData.push(doc.data());
                });

                scoresData.sort((a, b) => {
                    if (b.score !== a.score) {
                        return b.score - a.score;
                    }
                    const timeA = a.timestamp && a.timestamp.toMillis ? a.timestamp.toMillis() : 0;
                    const timeB = b.timestamp && b.timestamp.toMillis ? b.timestamp.toMillis() : 0;
                    return timeB - timeA; 
                });
                
                const topScores = scoresData.slice(0, 10); 

                if (topScores.length === 0) {
                    noHighScoresMsg.style.display = 'block';
                } else {
                    topScores.forEach((data, index) => {
                        const listItem = document.createElement('li');
                        listItem.className = 'flex justify-between items-center p-2 bg-slate-700 rounded-md';
                        
                        let medal = '';
                        if (index === 0) medal = 'ü•á ';
                        else if (index === 1) medal = 'ü•à ';
                        else if (index === 2) medal = 'ü•â ';

                        const difficultyText = data.difficulty ? ` <span class="text-xs text-slate-400">(${data.difficulty})</span>` : '';

                        listItem.innerHTML = `
                            <span>${medal}${data.name}${difficultyText}</span>
                            <span class="font-semibold text-amber-300">${data.score} pts</span>
                        `;
                        highScoresListEl.appendChild(listItem);
                    });
                }
            } catch (error) {
                console.error("Erro ao buscar melhores pontua√ß√µes:", error);
                noHighScoresMsg.textContent = "Erro ao carregar pontua√ß√µes.";
                noHighScoresMsg.style.display = 'block';
                showModal("Erro no Placar", `N√£o foi poss√≠vel carregar as melhores pontua√ß√µes: ${error.message}`);
            } finally {
                highScoresLoadingSpinner.style.display = 'none';
            }
        }

        startGameBtn.addEventListener('click', startGame);
        nextQuestionBtn.addEventListener('click', nextQuestion);
        playAgainBtn.addEventListener('click', () => {
            gameScreen.style.display = 'none';
            endScreen.style.display = 'none';
            startScreen.style.display = 'block';
        }); 
        saveScoreBtn.addEventListener('click', saveHighScore);

        initializeFirebase();

    </script>
</body>
</html>